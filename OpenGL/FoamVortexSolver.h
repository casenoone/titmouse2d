#ifndef FOAMVORTEXSOLVER2_H
#define FOAMVORTEXSOLVER2_H


#include "FoamVortexData.h"
#include "../titmouse2d/src/Lagrangian/ParticleSystemSolver2.h"
#include "../titmouse2d/src/OtherMethod/SWE/ShallowWaveSolver2.h"
#include "../titmouse2d/src/boundingbox2.h"


#include <Eigen/Dense>


//坐标规定：
//x : pos.x
//y : height
//z : pos.y


class FoamVortexSolver : public ParticleSystemSolver2 {

public:
	FoamVortexSolver();

	//高度场与涡粒子耦合专用
	FoamVortexSolver(
		const Vector2I& resolution,
		const Vector2D& gridSpacing,
		const Vector2D& gridOrigin = Vector2D::zero());

	virtual void timeIntegration(double timeIntervalInSeconds)override;
	virtual void onAdvanceTimeStep(double timeIntervalInSeconds)override;
	FoamVortexDataPtr& foamVortexData();
	Vector2D computeUSingle(const Vector2D& pos, int i)const;
	void setMovingBoudnary(RegularPolygonPtr surfaces);
	void setStaticBoudnary(ExplicitSurface2Ptr surfaces);

	void emitTracerParticles();
	void emitParticlesFromPanels(double timeIntervalInSeconds);
	void emitVortexRing();
	//为高度场设置移动边界
	void setShallowWaveMovingBoundary(const Vector2D& center, const double r);

private:
	//求解tracer粒子
	void tracerParticlesSolve();

	//只要边界形状不变，边界矩阵就不会变
	//这个函数只调用一次
	void constructMovingBoundaryMatrix();

	void constructStaticBoundaryMatrix();

	//我也不想起这么长的名字
	Vector2D computeUnitVelocityFromPanels(const Vector2D& pos, int index);
	Vector2D static_computeUnitVelocityFromPanels(int index, const Vector2D& midPoint);
	void no_through_solve(double timeIntervalInSeconds);
	Vector2D static_computeSingleVelocityFromPanels(int index);

	void tarcerCollisionSolve(Vector2D& pos);

	void decayVorticity();

private:
	//计算bubble之间的排斥力
	Vector2D computeF_rB(int i, int j) const;

	//计算bubble之间的吸引力
	Vector2D computeF_aB(int i, int j) const;

	//计算障碍物对bubble的吸引力
	void computeF_a0();

	//计算所有的吸引力和排斥力
	void computeF_ra();

	//计算空气阻力
	Vector2D computeF_air(int i);

	//计算所有的阻力
	void computeF_fr();

	//计算所有的力
	void computeTotalForce();

	//气泡消失，随机删除气泡
	void bubbleBreakUp();

public:
	ShallowWaveSolver2Ptr _shallowWaveSolver;

private:
	FoamVortexDataPtr _foamVortexData;
};



#endif
